pipeline {
    agent {
        kubernetes {
            defaultContainer 'jnlp'
            yamlFile 'docker_agentpod.yaml'
        }
    }
    environment {
        repo = "us-central1-docker.pkg.dev"
        repo_auth_id = "composite-area-316917"
        image_name = "composite-area-316917/dockerstore/asug"
        image_ver = "latest"
    }
    stages{
        stage("Build image"){
            steps{
                container("docker-container"){
                    sh 'echo "building ."'
                    sh "echo \"build num:${env.BUILD_NUMBER}\""
                    script {
                        app = docker.build("${repo}/${image_name}:${image_ver}")
                    }
                }
            }
        }
        stage("Test image"){
            steps{
                container("docker-container"){
                    sh 'echo "testing .."'
                    script{
                        app.inside {
                            sh 'echo "testing"'
                        }
                    }
                }
            }
        }
        stage("Push image"){
            steps{
                container("docker-container"){
                    sh 'echo "pushing ..."'
                    script {
                        docker.withRegistry("https://${repo}", repo_auth_id){
                            app.push("${env.BUILD_NUMBER}")
                            app.push("latest")
                        }
                    }
                }
            }
        }
    }
}
