pipeline {
    agent {
        kubernetes {
            defaultContainer 'jnlp'
            yamlFile 'docker_agentpod.yaml'
        }
    }
    environment {
        repo = "us-central1-docker.pkg.dev"
        repo_path = "composite-area-316917/dockerstore"
        repo_auth_id = "composite-area-316917-usrpass"
        image_name = "asug"
        image_ver = "latest"
    }
    stages{
        stage("Build image"){
            steps{
                container("docker-container"){
                    sh 'echo "building ."'
                    sh "echo \"build num:${env.BUILD_NUMBER}\""
                    script {
                        image = docker.build("${repo}/${repo_path}/${image_name}:${image_ver}")
                    }
                }
            }
            post {
                always {
                    jiraSendBuildInfo site: 'jh-itk-cpp.atlassian.net'
                }
            }
        }
        stage("Test image"){
            steps{
                container("docker-container"){
                    sh 'echo "testing .."'
                    script{
                        image.inside("-p 6080:8080 -v /dev/shm:/dev/shm", "tini") {
                            sh 'echo "testing"'.
                            sh 'geckodriver --version'
                            sh 'python3 --version'
                            sh 'pip --version'
                            sh 'sleep 120'
                            sh 'firefox -width=1080 -height=720 -url http://google.com'
                        }
                    }
                }
            }
        }
        stage("Push image"){
            steps{
                container("docker-container"){
                    sh 'echo "pushing ..."'
                    script {
                        docker.withRegistry("https://${repo}", repo_auth_id){
                            image.push("${env.BUILD_NUMBER}")
                            image.push("latest")
                        }
                    }
                }
            }
            post {
                always {
                    jiraSendDeploymentInfo site: 'jh-itk-cpp.atlassian.net', environmentId: 'test-ACPT-2-docker-gui-image', environmentName: 'kubepod: ACPT-2 build - docker gui image', environmentType: 'testing', issueKeys: ['ACPT-2']
                }
            }
        }
    }
}
